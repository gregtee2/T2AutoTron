import{a as b}from"./index-EfYqPVS2.js";const y=[];let g=null,w=0,N=0;function R(e){if(!e||!e.id){console.warn("[UnifiedNodeLoader] Invalid definition received:",e);return}console.log(`[UnifiedNodeLoader] Registered definition: ${e.id}`),y.push(e)}function S(e){const{ClassicPreset:a}=window.Rete,t=window.sockets;return class extends a.Node{constructor(o){if(super(e.label),this.width=e.width||300,this.height=e.height||200,this.changeCallback=o,this.definition=e,this.properties={},e.properties)for(const[c,l]of Object.entries(e.properties))this.properties[c]=l.default;if(this._state={},e.internalState&&(this._state=JSON.parse(JSON.stringify(e.internalState))),e.outputs)for(const[c,l]of Object.entries(e.outputs)){const d=l.type||"any",u=t[d]||new a.Socket(d);this.addOutput(c,new a.Output(u,l.label||c))}if(e.inputs)for(const[c,l]of Object.entries(e.inputs)){const d=l.type||"any",u=t[d]||new a.Socket(d);this.addInput(c,new a.Input(u,l.label||c,l.multipleConnections||!1))}}data(o){const c={now:()=>new Date,isBackend:!1},l=this.definition.execute(o,this.properties,c,this._state);if(l&&typeof l.then=="function")return console.warn(`[UnifiedNode] ${this.definition.id} returned a Promise - async not supported in frontend data()`),{};const d={...l};return delete d._warmup,delete d._tickCount,d}restore(o){o.properties&&Object.assign(this.properties,o.properties)}serialize(){return{...this.properties}}update(){this.changeCallback&&this.changeCallback()}}}function L(e){return function({data:t,emit:r}){const o=window.React,{useState:c,useEffect:l,useCallback:d}=o,u=window.RefComponent,{NodeHeader:I,HelpIcon:h}=window.T2Controls||{},[,C]=c(0);l(()=>{const n=t.changeCallback;return t.changeCallback=()=>{C(i=>i+1),n&&n()},()=>{t.changeCallback=n}},[t]);const E={now:()=>new Date,isBackend:!1};let m={};try{m=e.execute({},t.properties,E,t._state||{})||{}}catch(n){console.warn(`[UnifiedNode] Error executing ${e.id}:`,n)}const f=d((n,i)=>{t.properties[n]=i,t.changeCallback&&t.changeCallback()},[t]),v=(n,i)=>{const p=t.properties[n];switch(i.uiType){case"hidden":return null;case"text":return o.createElement("input",{type:"text",value:p||"",onChange:s=>f(n,s.target.value),onPointerDown:s=>s.stopPropagation(),style:{width:"100%",padding:"4px",background:"#333",color:"#fff",border:"1px solid #555",borderRadius:"4px"}});case"number":return o.createElement("input",{type:"number",value:p??0,min:i.min,max:i.max,onChange:s=>f(n,parseFloat(s.target.value)||0),onPointerDown:s=>s.stopPropagation(),style:{width:"60px",padding:"4px",background:"#333",color:"#fff",border:"1px solid #555",borderRadius:"4px"}});case"select":return o.createElement("select",{value:p||i.default,onChange:s=>f(n,s.target.value),onPointerDown:s=>s.stopPropagation(),style:{padding:"4px",background:"#333",color:"#fff",border:"1px solid #555",borderRadius:"4px"}},(i.options||[]).map(s=>o.createElement("option",{key:s,value:s},s)));case"toggle":return o.createElement("button",{onClick:()=>f(n,!p),onPointerDown:s=>s.stopPropagation(),style:{padding:"4px 12px",background:p?"#4caf50":"#555",color:"#fff",border:"none",borderRadius:"4px",cursor:"pointer"}},p?"ON":"OFF");default:return o.createElement("span",{},String(p))}},k=t.inputs?Object.entries(t.inputs).map(([n,i])=>({key:n,...i})):[],x=t.outputs?Object.entries(t.outputs).map(([n,i])=>({key:n,...i})):[],U=t.width||e.width||300,P=t.height||e.height||400;return o.createElement("div",{className:"unified-node",style:{width:`${U}px`,minHeight:`${P-40}px`,padding:"12px",boxSizing:"border-box",display:"flex",flexDirection:"column",overflow:"visible"}},[o.createElement("div",{key:"title",className:"title",style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:"8px"}},[o.createElement("div",{key:"left",style:{display:"flex",alignItems:"center",gap:"6px"}},[o.createElement("span",{key:"icon"},e.icon||"ðŸ“¦"),o.createElement("span",{key:"label"},t.properties.customName||e.label)]),h&&o.createElement(h,{key:"help",text:e.helpText,size:14})]),k.length>0&&o.createElement("div",{key:"inputs",className:"unified-inputs-section",style:{marginBottom:"8px"}},k.map(n=>o.createElement("div",{key:n.key,className:"unified-input-row",style:{display:"flex",alignItems:"center",justifyContent:"flex-start",padding:"2px 0"}},[o.createElement(u,{key:"socket",init:i=>r({type:"render",data:{type:"socket",element:i,payload:n.socket,nodeId:t.id,side:"input",key:n.key}}),unmount:i=>r({type:"unmount",data:{element:i}})}),o.createElement("span",{key:"label",className:"unified-socket-label",style:{marginLeft:"8px",fontSize:"12px",color:"#aaa"}},e.inputs?.[n.key]?.label||n.key)]))),x.length>0&&o.createElement("div",{key:"outputs",className:"unified-outputs-section",style:{marginBottom:"8px"}},x.map(n=>o.createElement("div",{key:n.key,className:"unified-output-row",style:{display:"flex",alignItems:"center",justifyContent:"flex-end",padding:"2px 0"}},[o.createElement("span",{key:"label",className:"unified-socket-label",style:{marginRight:"8px",fontSize:"12px",color:"#aaa"}},e.outputs?.[n.key]?.label||n.key),o.createElement("span",{key:"value",style:{marginRight:"8px",fontSize:"11px",color:"#4caf50",fontFamily:"monospace"}},m[n.key]!==void 0?String(m[n.key]):"â€”"),o.createElement(u,{key:"socket",init:i=>r({type:"render",data:{type:"socket",element:i,payload:n.socket,nodeId:t.id,side:"output",key:n.key}}),unmount:i=>r({type:"unmount",data:{element:i}})})]))),e.properties&&o.createElement("div",{key:"controls",className:"content",style:{display:"flex",flexDirection:"column",gap:"8px"},onPointerDown:n=>n.stopPropagation()},Object.entries(e.properties).filter(([n,i])=>i.uiType!=="hidden").map(([n,i])=>o.createElement("div",{key:n,className:"control-row",style:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:"8px"}},[o.createElement("span",{key:"label",className:"control-label",style:{fontSize:"12px",color:"#aaa"}},i.label||n),v(n,i)])))])}}function O(){const e=window.nodeRegistry;if(!e)return console.error("[UnifiedNodeLoader] window.nodeRegistry not available"),[];const a=[];for(const t of y){if(t.hidden){console.log(`[UnifiedNodeLoader] Skipping hidden node: ${t.id} (backend-only, frontend uses existing UI)`);continue}try{const r=S(t),o=L(t);e.register(t.id,{label:t.label,category:t.category||"Unified",nodeClass:r,component:o,factory:c=>new r(c)}),a.push(t.id),console.log(`[UnifiedNodeLoader] Registered node: ${t.id} in category: ${t.category}`)}catch(r){console.error(`[UnifiedNodeLoader] Failed to process ${t.id}:`,r)}}return y.length=0,a}async function $(){return g||(g=(async()=>{try{const e=await fetch(b("/api/unified-plugins"));if(!e.ok)return console.warn("[UnifiedNodeLoader] Could not fetch unified plugins list"),[];const a=await e.json();if(N=a.length,a.length===0)return console.log("[UnifiedNodeLoader] No unified plugins found"),[];console.log(`[UnifiedNodeLoader] Loading ${a.length} unified plugins...`);for(const r of a)try{await j(b(`/${r}`)),w++}catch(o){console.error(`[UnifiedNodeLoader] Failed to load ${r}:`,o)}const t=O();return console.log(`[UnifiedNodeLoader] Completed: ${t.length} unified nodes registered`),t}catch(e){return console.error("[UnifiedNodeLoader] Error loading unified plugins:",e),[]}})(),g)}function j(e){return new Promise((a,t)=>{const r=document.createElement("script");r.src=e,r.async=!0,r.onload=()=>a(),r.onerror=()=>t(new Error(`Failed to load script: ${e}`)),document.head.appendChild(r)})}typeof window<"u"&&(window.UnifiedNodeLoader={registerDefinition:R,loadUnifiedPlugins:$,getStats:()=>({pendingCount:y.length,loadedCount:w,totalCount:N})});export{$ as loadUnifiedPlugins,R as registerDefinition};
