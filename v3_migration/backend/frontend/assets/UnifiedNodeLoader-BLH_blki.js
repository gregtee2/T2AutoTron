import{a as x}from"./index-jYP22ouP.js";const y=[];let g=null,b=0,N=0;window.UnifiedDefinitions=window.UnifiedDefinitions||{};window.executeUnified=function(t,s,e,r){const n=window.UnifiedDefinitions[t];if(!n||!n.execute)return console.warn(`[executeUnified] Definition not found: ${t}`),null;const c={now:()=>new Date,isBackend:!1},l=r||{};try{return n.execute(s,e,c,l)}catch(d){return console.error(`[executeUnified] Error executing ${t}:`,d),null}};function $(t){if(!t||!t.id){console.warn("[UnifiedNodeLoader] Invalid definition received:",t);return}console.log(`[UnifiedNodeLoader] Registered definition: ${t.id}`),y.push(t)}function P(t){const{ClassicPreset:s}=window.Rete,e=window.sockets;return class extends s.Node{constructor(n){if(super(t.label),this.width=t.width||300,this.height=t.height||200,this.changeCallback=n,this.definition=t,this.properties={},t.properties)for(const[c,l]of Object.entries(t.properties))this.properties[c]=l.default;if(this._state={},t.internalState&&(this._state=JSON.parse(JSON.stringify(t.internalState))),t.outputs)for(const[c,l]of Object.entries(t.outputs)){const d=l.type||"any",u=e[d]||new s.Socket(d);this.addOutput(c,new s.Output(u,l.label||c))}if(t.inputs)for(const[c,l]of Object.entries(t.inputs)){const d=l.type||"any",u=e[d]||new s.Socket(d);this.addInput(c,new s.Input(u,l.label||c,l.multipleConnections||!1))}}data(n){const c={now:()=>new Date,isBackend:!1},l=this.definition.execute(n,this.properties,c,this._state);if(l&&typeof l.then=="function")return console.warn(`[UnifiedNode] ${this.definition.id} returned a Promise - async not supported in frontend data()`),{};const d={...l};return delete d._warmup,delete d._tickCount,d}restore(n){n.properties&&Object.assign(this.properties,n.properties)}serialize(){return{...this.properties}}update(){this.changeCallback&&this.changeCallback()}}}function R(t){return function({data:e,emit:r}){const n=window.React,{useState:c,useEffect:l,useCallback:d}=n,u=window.RefComponent,{NodeHeader:j,HelpIcon:h}=window.T2Controls||{},[,C]=c(0);l(()=>{const o=e.changeCallback;return e.changeCallback=()=>{C(i=>i+1),o&&o()},()=>{e.changeCallback=o}},[e]);const E={now:()=>new Date,isBackend:!1};let m={};try{m=t.execute({},e.properties,E,e._state||{})||{}}catch(o){console.warn(`[UnifiedNode] Error executing ${t.id}:`,o)}const f=d((o,i)=>{e.properties[o]=i,e.changeCallback&&e.changeCallback()},[e]),U=(o,i)=>{const p=e.properties[o];switch(i.uiType){case"hidden":return null;case"text":return n.createElement("input",{type:"text",value:p||"",onChange:a=>f(o,a.target.value),onPointerDown:a=>a.stopPropagation(),style:{width:"100%",padding:"4px",background:"#333",color:"#fff",border:"1px solid #555",borderRadius:"4px"}});case"number":return n.createElement("input",{type:"number",value:p??0,min:i.min,max:i.max,onChange:a=>f(o,parseFloat(a.target.value)||0),onPointerDown:a=>a.stopPropagation(),style:{width:"60px",padding:"4px",background:"#333",color:"#fff",border:"1px solid #555",borderRadius:"4px"}});case"select":return n.createElement("select",{value:p||i.default,onChange:a=>f(o,a.target.value),onPointerDown:a=>a.stopPropagation(),style:{padding:"4px",background:"#333",color:"#fff",border:"1px solid #555",borderRadius:"4px"}},(i.options||[]).map(a=>n.createElement("option",{key:a,value:a},a)));case"toggle":return n.createElement("button",{onClick:()=>f(o,!p),onPointerDown:a=>a.stopPropagation(),style:{padding:"4px 12px",background:p?"#4caf50":"#555",color:"#fff",border:"none",borderRadius:"4px",cursor:"pointer"}},p?"ON":"OFF");default:return n.createElement("span",{},String(p))}},w=e.inputs?Object.entries(e.inputs).map(([o,i])=>({key:o,...i})):[],k=e.outputs?Object.entries(e.outputs).map(([o,i])=>({key:o,...i})):[],v=e.width||t.width||300,S=e.height||t.height||400;return n.createElement("div",{className:"unified-node",style:{width:`${v}px`,minHeight:`${S-40}px`,padding:"12px",boxSizing:"border-box",display:"flex",flexDirection:"column",overflow:"visible"}},[n.createElement("div",{key:"title",className:"title",style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:"8px"}},[n.createElement("div",{key:"left",style:{display:"flex",alignItems:"center",gap:"6px"}},[n.createElement("span",{key:"icon"},t.icon||"ðŸ“¦"),n.createElement("span",{key:"label"},e.properties.customName||t.label)]),h&&n.createElement(h,{key:"help",text:t.helpText,size:14})]),w.length>0&&n.createElement("div",{key:"inputs",className:"unified-inputs-section",style:{marginBottom:"8px"}},w.map(o=>n.createElement("div",{key:o.key,className:"unified-input-row",style:{display:"flex",alignItems:"center",justifyContent:"flex-start",padding:"2px 0"}},[n.createElement(u,{key:"socket",init:i=>r({type:"render",data:{type:"socket",element:i,payload:o.socket,nodeId:e.id,side:"input",key:o.key}}),unmount:i=>r({type:"unmount",data:{element:i}})}),n.createElement("span",{key:"label",className:"unified-socket-label",style:{marginLeft:"8px",fontSize:"12px",color:"#aaa"}},t.inputs?.[o.key]?.label||o.key)]))),k.length>0&&n.createElement("div",{key:"outputs",className:"unified-outputs-section",style:{marginBottom:"8px"}},k.map(o=>n.createElement("div",{key:o.key,className:"unified-output-row",style:{display:"flex",alignItems:"center",justifyContent:"flex-end",padding:"2px 0"}},[n.createElement("span",{key:"label",className:"unified-socket-label",style:{marginRight:"8px",fontSize:"12px",color:"#aaa"}},t.outputs?.[o.key]?.label||o.key),n.createElement("span",{key:"value",style:{marginRight:"8px",fontSize:"11px",color:"#4caf50",fontFamily:"monospace"}},m[o.key]!==void 0?String(m[o.key]):"â€”"),n.createElement(u,{key:"socket",init:i=>r({type:"render",data:{type:"socket",element:i,payload:o.socket,nodeId:e.id,side:"output",key:o.key}}),unmount:i=>r({type:"unmount",data:{element:i}})})]))),t.properties&&n.createElement("div",{key:"controls",className:"content",style:{display:"flex",flexDirection:"column",gap:"8px"},onPointerDown:o=>o.stopPropagation()},Object.entries(t.properties).filter(([o,i])=>i.uiType!=="hidden").map(([o,i])=>n.createElement("div",{key:o,className:"control-row",style:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:"8px"}},[n.createElement("span",{key:"label",className:"control-label",style:{fontSize:"12px",color:"#aaa"}},i.label||o),U(o,i)])))])}}function L(){const t=window.nodeRegistry;if(!t)return console.error("[UnifiedNodeLoader] window.nodeRegistry not available"),[];const s=[];for(const e of y){if(window.UnifiedDefinitions[e.id]=e,console.log(`[UnifiedNodeLoader] Stored definition: ${e.id} (hidden: ${!!e.hidden})`),e.hidden){console.log(`[UnifiedNodeLoader] Skipping UI registration for hidden node: ${e.id}`);continue}try{const r=P(e),n=R(e);t.register(e.id,{label:e.label,category:e.category||"Unified",nodeClass:r,component:n,factory:c=>new r(c)}),s.push(e.id),console.log(`[UnifiedNodeLoader] Registered node: ${e.id} in category: ${e.category}`)}catch(r){console.error(`[UnifiedNodeLoader] Failed to process ${e.id}:`,r)}}return y.length=0,s}async function O(){return g||(g=(async()=>{try{const t=await fetch(x("/api/unified-plugins"));if(!t.ok)return console.warn("[UnifiedNodeLoader] Could not fetch unified plugins list"),[];const s=await t.json();if(N=s.length,s.length===0)return console.log("[UnifiedNodeLoader] No unified plugins found"),[];console.log(`[UnifiedNodeLoader] Loading ${s.length} unified plugins...`);for(const r of s)try{await D(x(`/${r}`)),b++}catch(n){console.error(`[UnifiedNodeLoader] Failed to load ${r}:`,n)}const e=L();return console.log(`[UnifiedNodeLoader] Completed: ${e.length} unified nodes registered`),e}catch(t){return console.error("[UnifiedNodeLoader] Error loading unified plugins:",t),[]}})(),g)}function D(t){return new Promise((s,e)=>{const r=document.createElement("script");r.src=t,r.async=!0,r.onload=()=>s(),r.onerror=()=>e(new Error(`Failed to load script: ${t}`)),document.head.appendChild(r)})}typeof window<"u"&&(window.UnifiedNodeLoader={registerDefinition:$,loadUnifiedPlugins:O,getStats:()=>({pendingCount:y.length,loadedCount:b,totalCount:N})});export{O as loadUnifiedPlugins,$ as registerDefinition};
