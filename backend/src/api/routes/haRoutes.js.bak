const express = require('express');
const Joi = require('joi');
const chalk = require('chalk');
const homeAssistantManager = require('../../devices/managers/homeAssistantManager');

const logWithTimestamp = (message, level = 'info') => {
  const LOG_LEVEL = process.env.LOG_LEVEL || 'info';
  const timestamp = `[${new Date().toISOString()}]`;
  let formattedMessage = `${timestamp} `;
  if (['error'].includes(level) || (LOG_LEVEL === 'info' && ['info', 'warn'].includes(level)) || LOG_LEVEL === level) {
    switch (level) {
      case 'error':
        formattedMessage += `${chalk.red('❌ ' + message)}`;
        break;
      case 'warn':
        formattedMessage += `${chalk.yellow('⚠️ ' + message)}`;
        break;
      case 'info':
      default:
        formattedMessage += `${chalk.green('✅ ' + message)}`;
        break;
    }
    console.log(formattedMessage);
  }
};

module.exports = function (io) {
  const router = express.Router();

  router.use((req, res, next) => {
    const devices = homeAssistantManager.getDevices();
    if (!devices || devices.length === 0) {
      logWithTimestamp('Home Assistant devices not initialized yet.', 'error');
      return res.status(503).json({ success: false, error: 'Home Assistant devices not initialized yet.' });
    }
    next();
  });

  const stateSchema = Joi.object({
    on: Joi.boolean().required(),
    brightness: Joi.number().min(0).max(100).optional(),
    hs_color: Joi.array().items(Joi.number().min(0).max(360), Joi.number().min(0).max(100)).length(2).optional(),
    transition: Joi.number().min(0).optional()
  }).unknown(false);

  router.get('/', (req, res) => {
    try {
      const devices = homeAssistantManager.getDevices();
      logWithTimestamp(`Fetched ${devices.length} HA devices`, 'info');
      res.json({ success: true, devices });
    } catch (error) {
      logWithTimestamp(`Error fetching HA devices: ${error.message}`, 'error');
      res.status(500).json({ success: false, error: error.message });
    }
  });

  router.get('/:id/state', async (req, res) => {
    const { id } = req.params;
    logWithTimestamp(`Fetching state of HA device ${id}`, 'info');
    try {
      const result = await homeAssistantManager.getLightState(id);
      if (!result.success) {
        logWithTimestamp(`HA device ${id} not found or error: ${result.error}`, 'error');
        return res.status(404).json({ success: false, error: result.error || 'Device not found' });
      }
      logWithTimestamp(`Fetched state for HA device ${id}: ${JSON.stringify(result.state)}`, 'info');
      res.json(result);
    } catch (error) {
      logWithTimestamp(`Error fetching HA device ${id}: ${error.message}`, 'error');
      res.status(500).json({ success: false, error: error.message });
    }
  });

  router.put('/:id/state', async (req, res) => {
    const { id } = req.params;
    const body = req.body;
    logWithTimestamp(`Updating state of HA device ${id}: ${JSON.stringify(body)}`, 'info');
    const { error } = stateSchema.validate(body);
    if (error) {
      logWithTimestamp(`Validation error for HA device ${id}: ${error.details[0].message}`, 'error');
      return res.status(400).json({ success: false, error: error.details[0].message });
    }
    try {
      const entityType = id.replace('ha_', '').split('.')[0];
      const update = {
        on: body.on,
        brightness: body.brightness,
        hs_color: body.hs_color,
        transition: body.transition
      };
      if (entityType === 'switch' && (update.brightness || update.hs_color)) {
        logWithTimestamp(`Switch ${id} does not support brightness or color, ignoring`, 'warn');
        update.brightness = undefined;
        update.hs_color = undefined;
      }
      const result = await homeAssistantManager.updateLightState(id, update);
      if (!result.success) {
        logWithTimestamp(`Error updating HA device ${id}: ${result.error}`, 'error');
        return res.status(500).json({ success: false, error: result.error });
      }
      const stateResult = await homeAssistantManager.getLightState(id);
      if (stateResult.success) {
        if (io) {
          const state = {
            id,
            on: stateResult.state.on,
            brightness: stateResult.state.brightness,
            hs_color: stateResult.state.hs_color,
            vendor: 'HomeAssistant'
          };
          io.emit('device-state-update', state);
          logWithTimestamp(`Emitted device-state-update for ${id}: ${JSON.stringify(state)}`, 'info');
        }
        logWithTimestamp(`Successfully updated HA device ${id} to ${stateResult.state.on ? 'ON' : 'OFF'}, bri=${stateResult.state.brightness}`, 'info');
      } else {
        logWithTimestamp(`State verification failed for HA device ${id}: ${stateResult.error}`, 'error');
      }
      res.json({ success: true, message: 'State updated successfully' });
    } catch (error) {
      logWithTimestamp(`Error updating HA device ${id}: ${error.message}`, 'error');
      res.status(500).json({ success: false, error: error.message });
    }
  });

  return router;
};